(ns advent-2023.day-5
  (:require
    [advent.util :as util]
    [clojure.edn :as edn]
    [clojure.string :as str]
    [net.cgrand.xforms :as xf]))


(defn parse [s]
  (into []
        (map (fn [l]
               (let [[n & r] (remove str/blank?
                                     (str/split l #": |\n"))]
                 {:transform (re-find #"^[a-z-]+" n)
                  :mappings (into []
                                  (comp (map (fn [l]
                                               (edn/read-string (str "[" l "]"))))
                                        (xf/sort))
                                  r)})))
        (str/split s #"(?m)^$")))


(defn transform [n {mpgs :mappings}]
  (or (some (fn [[drs srs l]]
              (when (and (<= srs n)
                         (< n (+ srs l)))
                (+ drs (- n srs))))
            mpgs)
      n))


(defn part-1 [in]
  (let [[{[seeds] :mappings} & xfs] (parse in)]
    (util/min (map (fn [seed]
                     (reduce transform
                             seed
                             xfs)))
              seeds)))


(defn contiguous-ranges [mpgs]
  (loop [i 0
         ret []
         [[dst src l :as n] & r :as mpgs] mpgs]
    (if-not n
      (conj ret [i i (- Long/MAX_VALUE i)])
      (cond
        (< i dst) (recur dst
                         (conj ret
                               [i i (- dst i)])
                         mpgs)
        (= i dst) (recur (+ dst l)
                         (conj ret n)
                         r)))))


(defn range-contains? [[start end] x]
  (and (<= start x)
       (< x end)))


(defn ranges-overlap? [[s1 e1] [s2 e2]]
  (< (max s1 s2)
     (min e1 e2)))


(defn child-ranges [[stack [start end]]]
  (let [{mpgs :mappings} (peek stack)
        stack' (pop stack)]
    (sequence (comp (drop-while (fn [[dst src rl]]
                                  (< (+ dst rl) start)))
                    (util/take-upto (fn [[dst src rl]]
                                      (range-contains? [dst (+ dst rl)]
                                                       end)))
                    (map (fn [[dst src rl]]
                           (let [[s e] [(max start dst)
                                        (min end (+ dst rl))]]
                             [stack'
                              [(+ src (- s dst))
                               (+ src (- e dst))]]))))
              mpgs)))


(defn parse-2 [s]
  (let [[seeds & r] (parse s)]
    {:seeds (into []
                  (comp cat
                        (xf/partition 2))
                  (:mappings seeds))
     :transforms (into []
                       (map (fn [m]
                              (update m :mappings contiguous-ranges)))
                       r)}))



(defn part-2 [in]
  (let [{xforms :transforms
         seeds :seeds} (parse-2 in)
        init (some (fn [[stack [start :as soil]]]
                     (and (empty? stack)
                          (some (fn [[s l]]
                                  (when (ranges-overlap? soil
                                                         [s (+ s l)])
                                    (max s start)))
                                seeds)))
                   (tree-seq (fn [[stack rng]]
                               (seq stack))
                             child-ranges
                             [xforms [0 Long/MAX_VALUE]]))]
    (reduce transform
            init
            xforms)))

(comment
  (def t1 "seeds: 79 14 55 13\n\nseed-to-soil map:\n50 98 2\n52 50 48\n\nsoil-to-fertilizer map:\n0 15 37\n37 52 2\n39 0 15\n\nfertilizer-to-water map:\n49 53 8\n0 11 42\n42 0 7\n57 7 4\n\nwater-to-light map:\n88 18 7\n18 25 70\n\nlight-to-temperature map:\n45 77 23\n81 45 19\n68 64 13\n\ntemperature-to-humidity map:\n0 69 1\n1 0 69\n\nhumidity-to-location map:\n60 56 37\n56 93 4")

  (parse t1)

  (transform 13
             {:transform "seed-to-soil", :mappings [[50 98 2] [52 50 48]]}
             )

  (part-1 t1)
  (part-1 "seeds: 629551616 310303897 265998072 58091853 3217788227 563748665 2286940694 820803307 1966060902 108698829 190045874 3206262 4045963015 223661537 1544688274 293696584 1038807941 31756878 1224711373 133647424\n\nseed-to-soil map:\n3809825462 2725979505 339457863\n3359244708 2085610478 450580754\n652041572 2536191232 189788273\n841829845 3346349446 343599367\n1408035723 73701258 732851393\n2140887116 3689948813 88205018\n0 3778153831 371129494\n2953980724 0 73701258\n3027681982 1754047752 331562726\n2229092134 1029159162 724888590\n1185429212 806552651 222606511\n371129494 3065437368 280912078\n\nsoil-to-fertilizer map:\n201390752 0 263005475\n772560454 263005475 186665885\n3597849741 3228095269 216867970\n959226339 951560560 85171934\n2882237029 3813801625 34286208\n0 586356609 16090261\n1460387186 1189054013 136970257\n2511361703 2581174071 147006778\n201110502 1477157137 280250\n3582774663 3444963239 15075078\n2073881675 2245158204 30510333\n3127914126 3163440286 64654983\n1724767985 602446870 349113690\n1597357443 1036732494 127410542\n1044398273 1164143036 24910977\n635875205 449671360 136685249\n2916523237 2728180849 211390889\n1069309250 1854080268 391077936\n167223128 1820192894 33887374\n4168481019 2454687794 126486277\n3496254979 4048626015 86519684\n2454687794 4238293387 56673909\n2104392008 1648916365 171276529\n3814717711 3460038317 353763308\n464396227 1477437387 171478978\n2658368481 2939571738 223868548\n16090261 1326024270 151132867\n3393107291 4135145699 103147688\n3192569109 3848087833 200538182\n\nfertilizer-to-water map:\n357701033 441924316 54941059\n2047098412 1574732688 106451110\n2414997091 2961420861 217583761\n3647103220 3202843177 147888878\n1781607871 3397471081 265490541\n433955285 629676938 29320532\n3280739425 2494455782 366363795\n2818710889 1426835569 147897119\n1120892574 3179004622 23838555\n1539573533 3662961622 195295312\n3794992098 1820059317 63264836\n0 84223283 357701033\n1144731129 1702496991 117562326\n2153549522 2046878176 261447569\n593734757 726830618 239035306\n987137385 83279657 943626\n2966608008 0 83279657\n1734868845 3350732055 46739026\n1438972249 2860819577 100601284\n2632580852 2308325745 186130037\n1262293455 965865924 108845646\n412642092 1681183798 21313193\n472462518 1305563330 121272239\n988081011 496865375 132811563\n463275817 2037691475 9186701\n3049887665 1074711570 230851760\n832770063 1883324153 154367322\n1371139101 658997470 67833148\n\nwater-to-light map:\n4062286509 3839153068 91029970\n1610728246 3827168971 11474903\n2753947407 2725849236 1101319735\n2525484879 1829977386 228462528\n657837215 1095779595 241604827\n1895347620 1337384422 492592964\n1425623249 4009599599 185104997\n2446068318 3930183038 79416561\n1894838426 3838643874 509194\n2389619503 896001044 56448815\n3855267142 2058439914 207019367\n1187459420 657837215 238163829\n1622203149 2467395620 172372577\n2387940584 952449859 1678919\n985523081 2265459281 201936339\n4153316479 954128778 141650817\n1794575726 4194704596 100262700\n899442042 2688664470 37184766\n936626808 2639768197 48896273\n\nlight-to-temperature map:\n0 2682471120 43545350\n2829609407 2423668531 227914183\n3685065657 3821208881 65673550\n1319277847 0 33132672\n818263707 3091863377 5216721\n3144636417 670795080 1340457\n1352410519 895535914 570572224\n2709351136 1662268878 120258271\n115643652 2726016470 93054822\n455333494 1538206440 124062438\n3839611769 4030334543 30664857\n3750739207 4258515305 36451991\n2070721515 33132672 155555065\n3132740473 2067641423 5192544\n4147162986 3685065657 58311172\n4278703737 3743376829 16263559\n1070098598 2174489282 249179249\n716608392 2072833967 101655315\n43545350 1466108138 72098302\n3057523590 3016646494 75216883\n2700979566 887164344 8371570\n4205474158 4060999400 73229579\n2226276580 188687737 474702986\n1971879519 1968799427 98841996\n3931845119 4134228979 124286326\n579395932 2819071292 137212460\n3137933017 672135537 6703400\n1062694241 663390723 7404357\n3787191198 3886882431 52420571\n269061216 1782527149 186272278\n1031805835 2651582714 30888406\n823480428 678838937 208325407\n3870276626 3759640388 61568493\n4056131445 3939303002 91031541\n1922982743 3097080098 48896776\n208698474 2956283752 60362742\n\ntemperature-to-humidity map:\n219529182 731674447 232727899\n2748076784 2771987989 46463882\n2514344851 4061235363 233731933\n0 1369964423 219529182\n452257081 362359049 21789881\n4243457964 2720478657 51509332\n3085663754 3109574959 64704581\n1639319644 384148930 347525517\n3150368335 3626166922 251414834\n1986845161 0 139120377\n1382707786 1339581093 30383330\n1413091116 1113352565 226228528\n2794540666 2818451871 291123088\n2125965538 338187591 24171458\n474046962 139120377 157229612\n2361125570 1100881680 12470885\n631276574 296349989 41837602\n3401783169 3428035243 198131679\n3989702261 3174279540 253755703\n2224646236 964402346 136479334\n2150136996 2299087215 74509240\n3806048654 3877581756 183653607\n3599914848 2514344851 206133806\n673114176 1589493605 709593610\n\nhumidity-to-location map:\n4029426902 1202474782 191291587\n2764446301 708692227 493782555\n2188304413 3350514524 33021460\n3318755823 4213528230 67155117\n2000392671 620732246 87959981\n3754724301 3075811923 274702601\n3258228856 1393766369 60526967\n2088352652 4113576469 99951761\n363515622 1849258760 614077493\n1213242541 342257124 11129119\n1733046668 353386243 267346003\n1224371660 4280683347 14283949\n2577070088 2888435710 187376213\n4220718489 2832149614 56286096\n324294413 1810037551 39221209\n3385910940 2463336253 368813361\n977593115 3383535984 235649426\n1238655609 3619185410 494391059\n4277004585 324294413 17962711\n2221325873 1454293336 355744215")

  (util/time-ms 1000 (part-2 in))

  )
