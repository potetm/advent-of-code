(ns advent-2017.day-5
  (:require
    [clojure.string :as str]))

(def toy-data "0\n3\n0\n1\n-3")
(def data "0\n2\n0\n0\n-2\n-2\n-1\n-4\n-5\n-6\n0\n1\n-5\n-3\n-10\n-8\n-2\n-13\n-14\n-15\n-8\n-5\n-13\n-16\n-21\n-3\n-14\n-23\n-9\n-11\n-19\n-29\n-2\n-20\n-28\n1\n-3\n-35\n1\n-20\n-4\n-37\n-11\n-27\n-33\n-43\n-20\n-5\n-9\n-22\n-47\n-5\n-49\n-13\n-22\n-2\n-2\n-51\n-53\n-22\n-38\n-16\n-37\n-30\n-49\n-48\n-35\n-5\n-42\n-21\n-31\n-61\n-43\n-31\n-72\n-35\n-3\n-31\n-65\n-78\n2\n-17\n-80\n-10\n-6\n-68\n-69\n-44\n-71\n-78\n-89\n-19\n-22\n-28\n-21\n-7\n-54\n-63\n-48\n-70\n-73\n-52\n-47\n-49\n-2\n-91\n-65\n-76\n-58\n-47\n-45\n-21\n-11\n-112\n-80\n-93\n-98\n-41\n-54\n-105\n-36\n-102\n-75\n-102\n-67\n-100\n-41\n-56\n-19\n-90\n-5\n-66\n-41\n-3\n-32\n-95\n-65\n-44\n-1\n1\n-62\n-7\n-29\n-61\n-7\n1\n-63\n0\n-20\n-58\n-58\n-7\n-54\n-80\n-48\n-51\n-151\n-141\n-37\n-122\n-130\n-132\n-158\n-117\n-63\n-103\n-130\n-116\n-130\n-63\n-134\n-131\n-59\n-30\n-33\n-38\n-127\n-31\n-76\n-35\n-162\n-132\n-121\n-31\n-28\n-2\n-29\n-148\n-156\n-168\n2\n-33\n-85\n-25\n-18\n-167\n-152\n-22\n-38\n-136\n-83\n-46\n-73\n-139\n-15\n-185\n-197\n-125\n-159\n-80\n-161\n-158\n-82\n-36\n-52\n-210\n-200\n-90\n-199\n-70\n-135\n-195\n-54\n-156\n-46\n-74\n-73\n-221\n-96\n-37\n-189\n-27\n-209\n-30\n-50\n-4\n-74\n-15\n-184\n2\n-78\n-33\n-37\n-99\n-65\n-196\n-32\n-36\n-188\n-62\n-5\n-244\n-116\n-150\n-118\n-124\n-54\n-28\n-43\n-208\n-205\n-95\n-90\n-129\n-242\n-70\n-144\n-64\n-247\n-170\n-213\n-40\n-173\n-90\n-77\n-139\n-56\n-70\n-120\n-9\n-68\n-78\n-7\n-123\n-103\n-173\n-254\n-249\n-246\n-139\n-192\n-92\n-204\n-71\n-199\n-56\n-63\n-231\n-23\n-115\n-240\n-51\n-200\n-184\n-287\n-98\n-7\n-81\n-275\n-262\n-260\n-32\n-99\n-28\n-199\n-160\n-176\n-210\n-244\n-162\n-82\n-35\n-276\n-71\n-114\n-222\n-294\n-28\n-122\n-110\n-178\n-264\n-239\n-104\n-85\n-11\n-117\n-15\n-69\n-275\n-289\n-212\n1\n-296\n-285\n-9\n-95\n-149\n-197\n-152\n-141\n-148\n-138\n-173\n-224\n-297\n-299\n-53\n-335\n-36\n-17\n-291\n-25\n-211\n-175\n-104\n-328\n-58\n-15\n-198\n-102\n-122\n-211\n-74\n-117\n-205\n-143\n-353\n-187\n-323\n-172\n-133\n-170\n-41\n-92\n-84\n-72\n-352\n-278\n-164\n-124\n-175\n-113\n-175\n-152\n-160\n-33\n-126\n-226\n-237\n-135\n-156\n-190\n-378\n-168\n-271\n-240\n-111\n-398\n-91\n-243\n-336\n-311\n-368\n-396\n-202\n-262\n-18\n-303\n-363\n-67\n-36\n-284\n-404\n-120\n-97\n-387\n-26\n-135\n-112\n-325\n-82\n-53\n-307\n-410\n-276\n-384\n-64\n-60\n-412\n-335\n-356\n-82\n-134\n-251\n-408\n-342\n-9\n-73\n-27\n-388\n-434\n-80\n-231\n-114\n0\n-64\n-325\n-251\n-153\n-109\n1\n-92\n-167\n-89\n-454\n-154\n-13\n-283\n-231\n-357\n-244\n-324\n-134\n-41\n-380\n-169\n-247\n-301\n-297\n-388\n-304\n-135\n-403\n-168\n-314\n-117\n-281\n-76\n-473\n-281\n-322\n-79\n-39\n-129\n-432\n-452\n-183\n-164\n-76\n-382\n-306\n-58\n-126\n-141\n-4\n-3\n-201\n-480\n-443\n-313\n-361\n-279\n-250\n-38\n-1\n-340\n-138\n-69\n-462\n-32\n-68\n-19\n-31\n-271\n-86\n-141\n-331\n-412\n-29\n-369\n-518\n-103\n-502\n-24\n-67\n-130\n-247\n-331\n-535\n-77\n-305\n-153\n-44\n-382\n-309\n-162\n-430\n-480\n-25\n-431\n-78\n-442\n-549\n-184\n-523\n-94\n-380\n-227\n-526\n-209\n-508\n-129\n-36\n-510\n-310\n-133\n-145\n-146\n-244\n-245\n-541\n-362\n-7\n-103\n-565\n-209\n2\n-140\n-51\n-572\n-28\n-354\n-525\n-148\n-79\n-176\n-34\n-396\n-162\n-374\n-448\n-76\n-87\n-136\n-584\n-179\n-230\n-490\n-361\n-333\n-328\n-34\n-524\n-273\n-195\n-32\n-520\n-260\n-506\n-576\n-422\n-115\n-65\n-285\n-314\n-322\n-146\n-287\n-251\n-585\n-326\n-77\n-250\n-321\n-334\n-560\n-455\n-523\n-90\n-234\n-343\n-457\n-395\n-173\n-560\n-474\n-118\n-244\n-263\n-493\n-597\n-232\n-237\n-619\n-372\n-416\n-142\n-93\n-546\n-538\n-198\n-574\n-250\n-491\n-168\n-47\n-247\n-127\n-641\n-228\n-192\n-545\n-543\n-172\n-220\n-277\n-647\n-87\n-198\n-450\n-247\n-15\n-406\n-562\n-335\n-436\n-665\n-362\n-211\n-582\n-178\n-523\n-232\n-287\n-635\n-33\n-666\n-577\n-54\n-509\n-271\n-561\n-491\n-512\n-212\n-269\n-473\n-460\n-587\n-209\n-538\n-14\n-303\n-360\n-275\n-125\n-373\n-108\n-31\n-314\n-639\n-220\n-52\n-378\n-398\n-369\n-594\n-204\n-423\n-441\n-447\n-27\n-495\n-595\n-352\n-388\n-127\n-424\n-609\n-435\n-626\n-191\n-46\n-363\n-15\n-557\n-433\n-53\n-680\n-129\n-462\n-40\n-598\n-246\n-468\n-600\n-351\n-409\n-89\n-732\n-178\n-472\n-335\n-622\n-563\n-322\n-261\n-63\n-671\n-291\n-591\n-518\n-373\n-615\n-727\n-553\n-166\n-108\n-723\n-77\n-736\n-364\n-765\n-49\n-41\n-99\n-134\n-684\n-281\n-530\n-545\n-372\n-570\n-48\n-288\n-583\n-421\n-601\n-162\n-176\n-414\n-735\n-195\n-786\n-656\n-488\n-744\n-256\n-345\n-152\n-44\n-29\n1\n-582\n-30\n-351\n-379\n-23\n-48\n-737\n-293\n-525\n-73\n-79\n-531\n-775\n-706\n-59\n-74\n-805\n-311\n-544\n-33\n-603\n-454\n-700\n-506\n-489\n-617\n-485\n-267\n-794\n-13\n-707\n-557\n-368\n-730\n-696\n-728\n-167\n-413\n-639\n-705\n-391\n-11\n-195\n-416\n-788\n-295\n-768\n-192\n-2\n-771\n-675\n-687\n-198\n-568\n-663\n-302\n-732\n-265\n-796\n-370\n-18\n-579\n-771\n-349\n-365\n-214\n-598\n-314\n-752\n-315\n-815\n-487\n-511\n-126\n-6\n-146\n-353\n-787\n-204\n-330\n-517\n-456\n-805\n-4\n-500\n-150\n-242\n-833\n-804\n-663\n-554\n-41\n-607\n-121\n-762\n-892\n-249\n-405\n-403\n-255\n-457\n-613\n-91\n-157\n-890\n-631\n-908\n-544\n-487\n-813\n-541\n-108\n-147\n-702\n-301\n-430\n-66\n-492\n-902\n-284\n-464\n-784\n-312\n-762\n-588\n-17\n-809\n-436\n-483\n-16\n-410\n-180\n-568\n-37\n-687\n-444\n-619\n-211\n-386\n-673\n-600\n-155\n-558\n-849\n-37\n-717\n-867\n-236\n-98\n-165\n-579\n-677\n-691\n-602\n-878\n-555\n-893\n-773\n-395\n-942\n-661\n-850\n-881\n-485\n-312\n-689\n-258\n-899\n-120\n-227\n-349\n-467\n-404\n-45\n-919\n-329\n-365\n-22\n-462\n-632\n-498\n-873\n-288\n-901\n-655\n-321\n-922\n-882\n-416\n-946\n-320\n-5\n-57\n-352\n-711\n-197\n-705\n-737\n-439\n-39\n-252\n-1002\n-617\n-373\n-605\n-887\n-451\n-824\n-455\n-66\n-619\n-18\n-404\n-64\n-736\n-44\n-381\n-447\n-567\n-877\n-411\n-216\n-635\n-598\n-419\n-577\n-142\n-189\n-917\n-692\n-153\n-2\n-116\n-172\n-423\n-886\n-454\n-492\n-491\n-656\n-832\n-1036\n-468\n-23\n-709\n-292\n-668\n-454\n-478\n-302\n-182\n-677\n-904\n-648\n-513\n-901\n-331\n-750\n-445\n-758\n-842\n-372\n-471\n-109\n-239\n-704\n-817\n-340\n-591\n-40")


(defn parse [s]
  (mapv (fn [n]
          (Long/parseLong n))
        (str/split-lines s)))

(comment
  {:current-idx 0
   :instrs [0 1 2 ..]})

(defn step-part-1 [{:keys [current-idx
                           instrs]}]
  (let [jmp-cnt (get instrs current-idx)]
    {:current-idx (+ current-idx
                     jmp-cnt)
     :instrs (update instrs
                     current-idx
                     inc)}))

(defn part-1 [instrs]
  (let [c (count instrs)]
    (count (take-while (fn [{:keys [current-idx]}]
                         (< current-idx c))
                       (iterate step-part-1
                                {:current-idx 0
                                 :instrs instrs})))))

(defn step-part-2 [{:keys [current-idx
                           instrs]}]
  (let [jmp-cnt (get instrs current-idx)]
    {:current-idx (+ current-idx
                     jmp-cnt)
     :instrs (update instrs
                     current-idx
                     (fn [offset]
                       (if (<= 3 offset)
                         (dec offset)
                         (inc offset))))}))

(defn part-2 [instrs]
  (let [c (count instrs)]
    (count (take-while (fn [{:keys [current-idx]}]
                         (< -1 current-idx c))
                       (iterate step-part-2
                                {:current-idx 0
                                 :instrs instrs})))))

(defn part-2-fast [instrs]
  (let [c (count instrs)
        instrs (long-array instrs)]
    (loop [current-idx 0
           step 1]
      (let [jmp-cnt (aget instrs current-idx)
            nxt-idx (+ jmp-cnt current-idx)]
        (if (and (< -1 nxt-idx)
                 (< nxt-idx c))
          (do (aset instrs
                    current-idx
                    (if (<= 3 jmp-cnt)
                      (dec jmp-cnt)
                      (inc jmp-cnt)))
              (recur nxt-idx
                     (inc step)))
          step)))))

(comment

  (part-1 (parse data))
  (part-2 (parse data))

  (time (part-2-fast (parse data)))
  (time (part-2 (parse data))))
