(ns advent-2022.day-8
  (:require
    [advent.util :as util]
    [clojure.string :as str]))


(defn parse [s]
  (util/transpose (mapv (fn [l]
                          (mapv #(Character/digit ^char % 10)
                                l))
                        (str/split-lines s))))


(defn split-line [v n]
  [(rseq (subvec v 0 n))
   (subvec v (inc n))])


(defn visible? [grid [x y :as pnt]]
  (let [col (get grid x)
        row (util/column grid y)
        v (get-in grid pnt)]
    (boolean (some (fn [l]
                     (every? #(< % v) l))
                   (concat (split-line col y)
                           (split-line row x))))))


(defn part-1 [in]
  (count (filter (partial visible? in)
                 (util/rect-points in))))


(defn score [grid [x y :as pnt]]
  (let [col (get grid x)
        row (util/column grid y)
        v (get-in grid pnt)]
    (util/product (map (fn [l]
                         (count (util/take-upto #(<= v %)
                                                l))))
                  (concat (split-line col y)
                          (split-line row x)))))


(defn part-2 [in]
  (util/max (map (partial score in))
            (util/rect-points in)))


(comment
  (def t "30373\n25512\n65332\n33549\n35390")
  (def in "202210010310302121322210423201220000314024242432211425434422230130411300321324302223011311211020120\n110110101310322320101034033124303343031143435122351113353455142421341123420341013300312303121102011\n022222013123323313404200430243020022232555432244334344444542122134130133413044342230233130022021112\n112111200212221204100121022244121453412414141145154551512445525421435232112124343223122023223002202\n010223032133232313122112411243113131542422453412413325334141424132125341004123403342031113000321021\n120203310013001113014232132353322341235134523424131353554135433255424414441323410043113010210021012\n001321033020303133033413032514323122112454135451341114535233523552111335315303411442413103332313030\n102233001100013210130402551555541521113335452154222626521451545151431543531541120332311401123233002\n000012220223113031313123321342142243351454565666666364326432622135251241345515402410441240003203231\n323120110213212212143353534544223242346225556633526325233365442515315454452135521422031032430131220\n010220310331203330225142431325531126553665336562254653354425352265653122233143242323103214302312331\n123101224243131422134414233423334544425633524646243233362664535663664554135351555324200233211032302\n100333303112401243331523125333225424454222662442543663456556432565564235231542334341022204140131010\n222320010441120114425514454524226565533325532623432265362636256446244663333511523325400304340133002\n001134131023140453514341254322262544543344626564433544326342336243252564355555514153411041322321023\n303032023104304131222142562326266256323662554334643363347342242532462534263352425422433133134401332\n020340310211345254242454444265454332565537636676554374476536357464242334364525332231411442341304333\n010424244214451151434435346345243633344375647763655474336663454733535632266334124355143530400222002\n020104234232554141451622326322264263647735447654367457344444465643453634336365231214525124433022444\n204201130004331123325262634265424363534754356365344543544653337444375665555552553542414222233041401\n231313304412112545143543446626577766674444573674633355336777737535543536546633462414421512204234400\n033341420245341341444352655236656744666536473763766674637573737455777566262423256254341313453322144\n440314332142235331442343546273646373345664657448647878767773563537357677642454354424141113554434301\n002021425352244536243253565466455346736677674884448677865868476765656674742534363462451133433430431\n312244242113113354564554337535376574767786648687855878644777578636677645574425532235315311343242411\n233122245155144565255556333557536764847587685667467874688477765747736733566463344232665353434242041\n022220452513455555322662755373537664785775876754758887458644778857853773647663236626545124422424320\n022230332331242525645255575733445554454765688768654845485674575556756764377537266433342513111411334\n120341111522144552663266354477644845848748677677644558776677456646677433474757754324325455254224404\n334433112533124466362636446457755674575647767878689757997654655557447467734646643623663324241123341\n044044511253635465446534354447476746444884889989857597797866787787888747443665545532456524224131143\n342122313235634465626773753655655586857767998568657675697899684787888655564663564432663444345124541\n300241415543242222674376454758578748859965896985789659878795778758468578856474655622353223553421340\n432555555434536525465544664745745888686778996656856565599757587746755745784533654644233622425515434\n004155142463225235434575577777764766596665569657879795765857577596467458644447634453564363532531433\n315114345132332442746733438647847847577597775567596889586878967997655654786546753744554456313434213\n323554311133626266375345655745865485788569878887677897756998589576556656784677663746632663332532151\n315144132232553537533354554654464598875898876799867967877875556975854576455736577735632354543155134\n222334432553634533666733477687556985579999867776999997898668878678867858466445453753652435255552353\n341334452524465435553736485655557568559699788977996667669999667955587886767744364375524653661522332\n413445246252544336676458575775678988988586687776978669888789889868875866467477435474464653535223233\n113143446226365337646448856475467575668778966797986666789967987866989544578754333667436355422314512\n323412424644366374665378846687555957879987766978769867869789986867696554454854656763756625325241145\n323421115545525643633547858847889999697776668979678976769897999899659875558684777565446323544324251\n432334334444542573375354656474858797778897676698987797799688968867795956877875445655545264424345232\n313421526625464654745784667555655877667866889997977998979899968958766968688884745767745342336522224\n122211264264562763544488484689975989588788879988798787779667786859558567878485674347334443246223344\n255242155636622443335485578658568685878777677999787778898767686987558788876846566435373364366424533\n413344156256433653574768654788878777978699969878998798887869869888598888664446534547775236363642425\n342124563455467737457658485456878998989988979899998897787987866875698669856575853463673655444534341\n232551266232426674334688468579688769898979978897788788899798868699975575444474737764445664236253252\n525112465464323755636656578776889996878689879787788998889987978986957695855668736377766252323353255\n335335445554653644563344554685858987978878788987977879778999967667869567488847763473767565562443553\n545321524224436644545685678886975585679878668999989988977889988665666777667584866437364423354233323\n111423266342443746543667554476875575666977668887778798797767868895568959486564657554473632445655344\n524212552355364477347365556488688656986668766897897789886896688988559599878748555366373562653454121\n131154335433422345634645655457568556886876787789779979987866669967997578577754745577462646226445314\n235252452335234564367678476887687995897898668678778786687699867598786667847747567563645652263343425\n223253143456366656767765746865557567566666767869789987989986887557956998685474637637366352326243542\n022325555334456567353758847454499775865697766886666678799897866988858868887447554444762544422112415\n343144416534333377537365468647569967688667888678877876698688967696987958488474576533553236464222515\n041455413553636645474356566857777797955967797767896696888698558569799657885773667663642263333432225\n314232125326436446553663846575645898685777676969798987998978856859686786577445377553744443245432243\n321243223546455364367743474758777659578658777997668897788989566685788888684476563345423344554443231\n415125254422442527666573645787574596577688978657789966586986685976985678486637347667436525212454543\n414235135545633363666356438757467669858969857687755898578857676858688644547753747345432366312551541\n440114242344345546336647565757454586855999757667866776678779875958488554786743465373523322335324440\n122344413244444335537455544748467554578788577997879979696958696984755857587433556336643245424414511\n404152532353256326373573456764878788486665786786686989885788858787846674744354647343463555324212243\n430052142415544522224767753334887658877858987557899587585858774486467688656755647656562452215444341\n340214451142655354335334667467484748684647966577756797796876564684745486774456744624442332555544214\n202003423413136555225554443743364668647485745965556658974868564455687766677646333424563244225312413\n124244252232546632354435547477575454458474888785648855588868547656747434644644562666356425513552234\n110004343225254552232245333753757468577454458667486664868686776847774656744433232645435354515511001\n114110243523312246646633667657446557887764577875444674586445668855646455464673426355246121241420242\n144004022115232335325233544457463354556577558686866645777668486456344336776563552654224535341204000\n421204313533552465364335665657756377478687485747568464457586578433533665377544334436324115345110242\n310213102455533546266535624345334376363684858775467657685555747353643644472546632522545411333203111\n114430325255224412546642432664757677554453367648667474866563366653547673545643556525445241221014044\n101202024124311141332246625344457736763773743567676364434654335437667673333633334533321141144401343\n022314412343141552545426345523734644465534437755555546366776455573555736346566554523431445312041141\n310102320115113413255662622463666645774475764474763576347553464576657544655232265213412332113321240\n103421443124221314341526656425352447567466347367455546655457665443752365626234642233144534440401232\n012242102421432341212413443326266462435353334443757554636776575352564544364326345342233211400021132\n222333320014022434154332424323323222343565375555437333746365455224462465255645335454253531041200430\n203301220423445445245343333566523444245653734664355375366356543225425453566551115535422214404241002\n302324443031122331441331256335344224253636533556756445434643354532564454235413132113211343002133211\n311312211414143323513134241534622563433242365626656422526345223354546364435315451551101023211412130\n222110343401032043553425111312244654332653464666435423342453322663424243153233322113032023202020223\n323230200411432130355525221321433355242633433225442453325522522622364253311533334354031100222010013\n310222312143433114242431355515315554643534324342445656666436353223444231435453241400213321330130010\n333003032313304033243534455111112214234262552344526635435332246231323535122413441024143242102302110\n113023202303413323324054115321135342223354425566256536556255312115424353351151533010221413210330113\n201002101132013010411214525353534241113423251253436544643553152152432455455322331331310031222312310\n010000023323114442204233214145222453523254543111213112525444545451354241122320331344023330301010000\n020221201301204043241340212025231451554512545355544454355334235544331435121232034423404333303220120\n211200133121002321411044312343241534545415435535214551522523534521342510432012433211020132222223110\n001010111333021232114033432123014243143421131445211232544521554534542030434313341020033312233321020\n110102200233103010320200140144034422131352541143533213514525422131220112004103004000011012120121220")

  (part-1 (parse in))
  (part-2 (parse in))

  (util/take-upto #(<= 5 %)
                  [1 2])

  (util/column (parse t)
               3)
  (score (parse t)
         [2 1])

  )
